{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% block content %}
{% for chat in chats %}
<button onclick="create_chat_window('{{chat.name}}')" class="btn btn-default" type="button">{{chat.name}}</button>

{% endfor %}
<style>
    .message-bubble
{
    padding: 10px 0px 10px 0px;
}



.message-bubble > *
{
    padding-left: 10px;
}

.panel-body { padding: 0px; }

.panel-heading { background-color: #3d6da7 !important; color: white !important; }

</style>
<script src="//code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>

<div class="row">
    <div id="myid" class="col-md-3"></div>
    <div class="col-md-5"></div>
    <div class="col-md-4">
        <!--
        <div class="panel panel-default">
            <div class="panel-heading">Panel heading without title</div>
            <div class="panel-body">
                <div class="container">
                    <div class="row message-bubble">
                        <p class="text-muted">Matt Townsen</p>
                        <p>nej</p>
                    </div>
                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input type="text" class="form-control">
                        <span class="input-group-btn">
                    <a href="#" class="btn btn-default" type="button">Send</a>
                  </span>
                    </div>
                </div>
            </div>
        </div>
-->

    </div>
</div>

<script type=text/javascript>
    function create_chat_window(id) {
        if ($('#' + id).length) {
            console.log("Chat window " + id + " already exists")
            $("#" + id).remove();
        } else {
            socket.emit('join', {room: id, survey: '123'});
            let panel = jQuery('<div/>', {
                id: id,
                class: 'panel panel-default'
            });

            let panelheading = jQuery('<div/>/', {
                class: 'panel-heading'
            });
            panelheading.html(id)

            let panelbody = jQuery('<div/>', {
                class: 'panel-body'
            })

            let container = jQuery('<div/>', {
                id: 'cid' + id,
                class: 'container'
            });

            let panelfooter = jQuery('<div/>', {
                class: 'panel-footer'
            });

            let inputgroup = jQuery('<div/>', {
                class: 'input-group'
            });

            let input = jQuery('<input/>', {
                id: 'inputid_' + id,
                class: 'form-control',
                type: 'text'
            });

            let span = jQuery('<span/>', {
                    class: 'input-group-btn'
                }
            );

            let button = jQuery('<a/>', {
                id: 'btnid_' + id,
                href: '#',
                class: 'btn btn-default send',
                type: 'button',
            });
            button.html('Send');
            button.on('click', emit_test(id))
            span = span.append(button)
            inputgroup = inputgroup.append(input).append(span)
            panelfooter = panelfooter.append(inputgroup)
            panelbody = panelbody.append(container).append(panelfooter);

            panel.append(panelheading).append(panelbody).appendTo('#myid')
        }

    }
</script>
<script>
    $(document).ready(function () {
        $(document).on('click', '.send', function () {
            emit_test(this.id);
            let inputid = this.id.replace('btnid_','#inputid_');
            $(inputid).val('');
        })
    });
</script>

<script type="text/javascript" charset="utf-8">
    const socket = io('http://127.0.0.1:5000/test');
    $(document).ready(function () {
        namespace = '/test';
        socket.on('connect', function () {

            //socket.emit('my_room_event', {room: '3', data: ('En forskare finns h√§r ')});
        });

    });
</script>

<script>
    function emit_test(id){
        let newid = id.replace('btnid_','');
        socket.emit('my_room_event', {room: newid, data: $('#inputid_'+newid).val() });
    }


</script>
<script>
 socket.on('my_response', function(msg, cb) {
                console.log('YES', msg.room)
                $('#cid'+msg.room).append('<br>' + $('<div/>').text(msg.data).html());
                $("#chatbox").animate({ scrollTop: 200000 }, "slow");

                if (cb)
                    cb();
            });
</script>
<p id="chatbox"></p>

{% endblock %}